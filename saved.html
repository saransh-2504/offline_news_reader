<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saved Articles</title>
  <link href="style.css" rel="stylesheet" />
</head>

<body>

  <header>
    <img class="head-img"
      src="https://media.istockphoto.com/id/1402360271/vector/seamless-pattern-with-a-collage-of-newspaper-or-magazine-clippings.jpg?s=612x612&w=0&k=20&c=GEGdqIvAipMBTeU3XQR6lHMCdonVWa1U13i05iUMrMw=" />
    <div class="title_fade-in">Saved Articles ‚ù§</div>
    <div class="logo_saved" onclick="history.back()">üîô</div>
  </header>
  <!-- NEWS GRID -->
  <div class="news-container fade-in" id="savedList">
  </div>
  <footer>
    ¬© 2025 Offline News Reader | Saved Articles
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let container = document.getElementById("savedList");

      // Open IndexedDB with correct version
      let request = indexedDB.open("newsDB", 3);

      request.onsuccess = function (e) {
        let db = e.target.result;

        // Load theme from IndexedDB
        try {
          let themeTx = db.transaction("settings", "readonly");
          let themeStore = themeTx.objectStore("settings");
          let themeReq = themeStore.get("themeMode");
          
          themeReq.onsuccess = () => {
            if (themeReq.result && themeReq.result.value === "dark") {
              document.body.classList.add("dark");
            }
          };
        } catch (e) {
          console.warn("Could not load theme:", e);
        }

        // Load saved articles
        let tx = db.transaction("saved", "readonly");
        let store = tx.objectStore("saved");
        let getAll = store.getAll();

        getAll.onsuccess = function () {
          let items = getAll.result || [];

          if (!items.length) {
            container.innerHTML = "<h2>No saved articles yet.</h2>";
            return;
          }

          items.forEach(item => {
            let card = document.createElement("div");
            card.className = "card";

            card.innerHTML = `
          <img src="${item.img || 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=600&h=400&fit=crop&q=80'}"
          alt="Saved Article Image"
          onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=600&h=400&fit=crop&q=80';"/>

          <div class="content">
            <div class="tag">SAVED</div>
            <div class="title-text">${item.title}</div>
            <div class="desc">${item.desc}</div>
            <div class="actions">
              <span class="delete-btn" data-link="${item.link}">üóë Delete</span>
              <a href="${item.link}" class="btn" target="_blank">Read More</a>
            </div>
          </div> `;

            container.appendChild(card);
          });

          // DELETE SAVED ARTICLE
          document.addEventListener("click", (e) => {
            if (e.target.classList.contains("delete-btn")) {
              let link = e.target.dataset.link;

              let tx2 = db.transaction("saved", "readwrite");
              let store2 = tx2.objectStore("saved");
              store2.delete(link);

              e.target.closest(".card").remove();

              if (!container.children.length) {
                container.innerHTML = "<h2>No saved articles yet.</h2>";
              }
            }
          });
        };
      };
      
      request.onerror = function () {
        container.innerHTML = "<h2>Could not open local DB.</h2>";
      };
    });
  </script>

  <!-- Register Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('‚úì Service Worker registered:', registration.scope);
          })
          .catch(error => {
            console.log('‚úó Service Worker registration failed:', error);
          });
      });
    }
  </script>

</body>
</html>